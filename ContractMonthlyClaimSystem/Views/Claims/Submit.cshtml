@model ContractMonthlyClaimSystem.Models.Claim

@{
    ViewData["Title"] = "Submit Claim";
    var userName = Context.Session.GetString("UserName") ?? "Lecturer";
    var userEmail = Context.Session.GetString("UserEmail") ?? "";
    var hourlyRate = Context.Session.GetString("HourlyRate") ?? "0";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-primary text-white py-3">
                    <h4 class="mb-0">
                        <i class="bi bi-file-earmark-plus me-2"></i>Submit Monthly Claim
                    </h4>
                    <small>Contract Monthly Claim System</small>
                </div>
                <div class="card-body p-4">
                    @if (TempData["SuccessMessage"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show">
                            <i class="bi bi-check-circle-fill me-2"></i>@TempData["SuccessMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>@TempData["ErrorMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Note:</strong> Your personal details and hourly rate are pre-filled from your HR profile.
                    </div>

                    <form asp-action="Submit" method="post" enctype="multipart/form-data" id="claimForm">
                        @Html.AntiForgeryToken()

                        <!-- Pre-filled Lecturer Information (Read-only) -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="LecturerName" class="form-label fw-semibold">
                                    <i class="bi bi-person me-1"></i>Lecturer Name
                                </label>
                                <input asp-for="LecturerName" class="form-control bg-light"
                                       value="@userName" readonly />
                                <small class="text-muted">Auto-filled from your profile</small>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="LecturerEmail" class="form-label fw-semibold">
                                    <i class="bi bi-envelope me-1"></i>Email Address
                                </label>
                                <input asp-for="LecturerEmail" type="email" class="form-control bg-light"
                                       value="@userEmail" readonly />
                                <small class="text-muted">Auto-filled from your profile</small>
                            </div>
                        </div>

                        <!-- Hourly Rate (Read-only, set by HR) -->
                        <div class="mb-3">
                            <label asp-for="HourlyRate" class="form-label fw-semibold">
                                <i class="bi bi-cash-coin me-1"></i>Hourly Rate (R)
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">R</span>
                                <input asp-for="HourlyRate" type="number" step="0.01"
                                       class="form-control bg-light" id="hourlyRate"
                                       value="@hourlyRate" readonly />
                            </div>
                            <small class="text-muted">Set by HR - contact HR to update</small>
                        </div>

                        <!-- Hours Worked (User Input) -->
                        <div class="mb-3">
                            <label asp-for="HoursWorked" class="form-label fw-semibold">
                                <i class="bi bi-clock me-1"></i>Hours Worked <span class="text-danger">*</span>
                            </label>
                            <input asp-for="HoursWorked" type="number" step="0.5" min="0.5" max="180"
                                   class="form-control form-control-lg" id="hoursWorked"
                                   placeholder="Enter hours worked this month" required />
                            <span asp-validation-for="HoursWorked" class="text-danger"></span>
                            <small class="text-muted">Maximum allowed: 180 hours per month</small>

                            <!-- Validation Warning -->
                            <div id="hoursWarning" class="alert alert-warning mt-2 d-none">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <span id="hoursWarningText"></span>
                            </div>
                        </div>

                        <!-- Auto-Calculated Total -->
                        <div class="card bg-success bg-opacity-10 border-success mb-3">
                            <div class="card-body">
                                <h5 class="card-title text-success">
                                    <i class="bi bi-calculator me-2"></i>Auto-Calculated Total
                                </h5>
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <p class="mb-1">
                                            <span id="displayHours">0</span> hours ×
                                            R <span id="displayRate">@hourlyRate</span>/hour
                                        </p>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <h3 class="text-success mb-0">
                                            R <span id="calculatedTotal">0.00</span>
                                        </h3>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Notes (Optional) -->
                        <div class="mb-3">
                            <label asp-for="Notes" class="form-label fw-semibold">
                                <i class="bi bi-chat-left-text me-1"></i>Additional Notes
                            </label>
                            <textarea asp-for="Notes" class="form-control" rows="3"
                                      placeholder="Any additional information about your claim..."></textarea>
                        </div>

                        <!-- Document Upload -->
                        <div class="mb-4">
                            <label for="upload" class="form-label fw-semibold">
                                <i class="bi bi-paperclip me-1"></i>Supporting Document <span class="text-danger">*</span>
                            </label>
                            <input type="file" name="upload" id="upload" class="form-control"
                                   accept=".pdf,.docx,.xlsx" required />
                            <small class="text-muted">
                                Allowed formats: PDF, DOCX, XLSX | Maximum size: 5MB
                            </small>
                        </div>

                        <hr>

                        <!-- Submit Buttons -->
                        <div class="d-flex justify-content-between">
                            <a asp-action="MyClaims" class="btn btn-outline-secondary btn-lg">
                                <i class="bi bi-arrow-left me-2"></i>Cancel
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                <i class="bi bi-send me-2"></i>Submit Claim
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Help Card -->
            <div class="card mt-3 border-0 bg-light">
                <div class="card-body">
                    <h6 class="fw-bold"><i class="bi bi-question-circle me-2"></i>Claim Process</h6>
                    <div class="row small">
                        <div class="col-md-3 text-center">
                            <span class="badge bg-primary rounded-pill">1</span>
                            <p class="mb-0 mt-1">Submit Claim</p>
                        </div>
                        <div class="col-md-3 text-center">
                            <span class="badge bg-warning text-dark rounded-pill">2</span>
                            <p class="mb-0 mt-1">Coordinator Review</p>
                        </div>
                        <div class="col-md-3 text-center">
                            <span class="badge bg-info rounded-pill">3</span>
                            <p class="mb-0 mt-1">Manager Approval</p>
                        </div>
                        <div class="col-md-3 text-center">
                            <span class="badge bg-success rounded-pill">4</span>
                            <p class="mb-0 mt-1">Payment</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const hoursInput = document.getElementById('hoursWorked');
            const rateInput = document.getElementById('hourlyRate');
            const totalDisplay = document.getElementById('calculatedTotal');
            const displayHours = document.getElementById('displayHours');
            const displayRate = document.getElementById('displayRate');
            const hoursWarning = document.getElementById('hoursWarning');
            const hoursWarningText = document.getElementById('hoursWarningText');
            const submitBtn = document.getElementById('submitBtn');

            const MAX_HOURS = 180;

            function calculateTotal() {
                const hours = parseFloat(hoursInput.value) || 0;
                const rate = parseFloat(rateInput.value) || 0;
                const total = hours * rate;

                // Update displays
                totalDisplay.textContent = total.toFixed(2);
                displayHours.textContent = hours;
                displayRate.textContent = rate.toFixed(2);

                // Validation for max hours
                if (hours > MAX_HOURS) {
                    hoursWarning.classList.remove('d-none');
                    hoursWarningText.textContent = `Hours exceed maximum limit of ${MAX_HOURS} hours per month. Please correct this.`;
                    submitBtn.disabled = true;
                    hoursInput.classList.add('is-invalid');
                } else if (hours > 160) {
                    hoursWarning.classList.remove('d-none');
                    hoursWarning.classList.remove('alert-warning');
                    hoursWarning.classList.add('alert-info');
                    hoursWarningText.textContent = `Note: ${hours} hours is above typical monthly hours. Please ensure this is correct.`;
                    submitBtn.disabled = false;
                    hoursInput.classList.remove('is-invalid');
                } else {
                    hoursWarning.classList.add('d-none');
                    submitBtn.disabled = false;
                    hoursInput.classList.remove('is-invalid');
                }
            }

            hoursInput.addEventListener('input', calculateTotal);

            // Initial calculation
            calculateTotal();

            // Form validation
            document.getElementById('claimForm').addEventListener('submit', function(e) {
                const hours = parseFloat(hoursInput.value) || 0;
                if (hours > MAX_HOURS) {
                    e.preventDefault();
                    alert('Hours cannot exceed ' + MAX_HOURS + ' per month.');
                    return false;
                }
                if (hours <= 0) {
                    e.preventDefault();
                    alert('Please enter valid hours worked.');
                    return false;
                }
            });
        });
    </script>
}